name: Test -> Release -> Promote Prod (o2switch)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

# Important : Ã©vite que 2 runs se marchent dessus
concurrency:
  group: o2switch-deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      CPANEL_SERVER: ${{ secrets.CPANEL_SERVER }}          # ex: truie.o2switch.net
      CPANEL_LOGIN:  ${{ secrets.CPANEL_LOGIN }}           # ex: keze7545
      CPANEL_TOKEN:  ${{ secrets.CPANEL_TOKEN }}           # token API cPanel
      O2SWITCH_REMOTE_RELEASE: ${{ secrets.O2SWITCH_REMOTE_RELEASE }}  # ssh://.../repositories/release
      O2SWITCH_REMOTE_PROD:    ${{ secrets.O2SWITCH_REMOTE_PROD }}     # ssh://.../repositories/tp-site
      SSH_PRIVATE_KEY: ${{ secrets.O2SWITCH_SSH_KEY }}

    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ---------
      # TESTS SIMPLES
      # ---------
      - name: Basic checks (structure)
        run: |
          set -euo pipefail
          test -f index.html || (echo "âŒ index.html manquant" >&2; exit 1)
          test -f Style.css || (echo "âŒ Style.css manquant" >&2; exit 1)

          # fichiers > 5MB (souvent inutile sur un site statique)
          if find . -type f -size +5M -not -path "./.git/*" | grep -q .; then
            echo "âŒ Fichiers > 5 Mo dÃ©tectÃ©s." >&2
            exit 1
          fi

      - name: HTML lint (tidy) - non bloquant
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y tidy
          # tidy retourne exit 1 si warnings : on ne bloque pas (tu avais plein de warnings)
          tidy -qe index.html || echo "âš ï¸ Tidy a signalÃ© des problÃ¨mes (non bloquant)"

      # ---------
      # OBTENIR IP + WHITELIST VIA API cPanel (o2switch firewall)
      # ---------
      - name: Get runner public IP
        id: ip
        run: |
          set -euo pipefail
          IP="$(curl -s https://api.ipify.org)"
          echo "ip=$IP" >> "$GITHUB_OUTPUT"
          echo "Runner IP: $IP"

      - name: Whitelist runner IP (o2switch firewall via cPanel API)
        run: |
          set -euo pipefail
          IP="${{ steps.ip.outputs.ip }}"

          # remove_all pour Ã©viter dâ€™empiler des IPs de runners
          curl -fsS -k \
            -H "Authorization: cpanel $CPANEL_LOGIN:$CPANEL_TOKEN" \
            "https://$CPANEL_SERVER:2083/execute/SshWhitelist/remove_all" || true

          # add lâ€™IP courante
          curl -fsS -k \
            -H "Authorization: cpanel $CPANEL_LOGIN:$CPANEL_TOKEN" \
            "https://$CPANEL_SERVER:2083/execute/SshWhitelist/add?address=$IP&comment=github-actions" > /dev/null

          echo "âœ… Whitelisted $IP on $CPANEL_SERVER"

      # ---------
      # SSH AGENT (clÃ© DOIT Ãªtre sans passphrase)
      # ---------
      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ env.SSH_PRIVATE_KEY }}

      - name: Add release/prod hosts to known_hosts
        run: |
          set -euo pipefail

          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # On extrait l'host depuis les URL ssh://user@HOST/...
          REL_HOST=$(echo "$O2SWITCH_REMOTE_RELEASE" | awk -F'[@/]' '{print $2}')
          PROD_HOST=$(echo "$O2SWITCH_REMOTE_PROD"    | awk -F'[@/]' '{print $2}')

          echo "Release host: $REL_HOST"
          echo "Prod host:    $PROD_HOST"

          ssh-keyscan -H "$REL_HOST"  >> ~/.ssh/known_hosts 2>/dev/null || true
          ssh-keyscan -H "$PROD_HOST" >> ~/.ssh/known_hosts 2>/dev/null || true

          chmod 600 ~/.ssh/known_hosts

      # ---------
      # PUSH -> RELEASE (repo cPanel)
      # ---------
      - name: Push to o2switch RELEASE repo
        run: |
          set -euo pipefail

          # sÃ©curitÃ©: si repo shallow, on "unshallow" (sinon erreur cÃ´tÃ© remote)
          if git rev-parse --is-shallow-repository | grep -q true; then
            git fetch --unshallow
          fi

          git remote remove o2switch_release 2>/dev/null || true
          git remote add o2switch_release "$O2SWITCH_REMOTE_RELEASE"

          # push de la branche courante (HEAD) vers main du repo cPanel
          git push --force o2switch_release HEAD:refs/heads/main

      - name: Trigger cPanel deploy for RELEASE (API)
        run: |
          set -euo pipefail
          curl -fsS -k \
            -H "Authorization: cpanel $CPANEL_LOGIN:$CPANEL_TOKEN" \
            "https://$CPANEL_SERVER:2083/execute/VersionControlDeployment/create?repository_root=/home/$CPANEL_LOGIN/repositories/release"

          echo "âœ… Release deploy triggered"

      # ---------
      # PUSH -> PROD (repo cPanel)
      # ---------
      - name: Push to o2switch PROD repo
        run: |
          set -euo pipefail

          if git rev-parse --is-shallow-repository | grep -q true; then
            git fetch --unshallow
          fi

          git remote remove o2switch_prod 2>/dev/null || true
          git remote add o2switch_prod "$O2SWITCH_REMOTE_PROD"

          git push --force o2switch_prod HEAD:refs/heads/main

      - name: Trigger cPanel deploy for PROD (API)
        run: |
          set -euo pipefail
          curl -fsS -k \
            -H "Authorization: cpanel $CPANEL_LOGIN:$CPANEL_TOKEN" \
            "https://$CPANEL_SERVER:2083/execute/VersionControlDeployment/create?repository_root=/home/$CPANEL_LOGIN/repositories/tp-site"

          echo "âœ… Prod deploy triggered"

      # ---------
      # CLEANUP (retire IP)
      # ---------
      - name: Remove runner IP from whitelist (cleanup)
        if: always()
        run: |
          set -euo pipefail
          IP="${{ steps.ip.outputs.ip }}"

          curl -fsS -k \
            -H "Authorization: cpanel $CPANEL_LOGIN:$CPANEL_TOKEN" \
            "https://$CPANEL_SERVER:2083/execute/SshWhitelist/remove?address=$IP" || true

          echo "ðŸ§¹ Removed $IP"
