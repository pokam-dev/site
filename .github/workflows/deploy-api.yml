name: Test -> Release -> Promote Prod (o2switch)

on:
  push:
    branches: ["main"]

concurrency:
  group: deploy-o2switch
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -------------------- TESTS --------------------
      - name: Basic project checks
        run: |
          set -e
          test -f index.html || (echo "❌ index.html manquant" >&2; exit 1)

          if find . -type f -size +5M -not -path "./.git/*" -not -path "./.github/*" | grep -q .; then
            echo "❌ Fichiers > 5 Mo détectés." >&2
            find . -type f -size +5M -not -path "./.git/*" -not -path "./.github/*"
            exit 1
          fi

      - name: HTML validation (tidy) non-bloquant
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y tidy
          tidy -errors -q index.html || echo "⚠️ Tidy a signalé des problèmes (non bloquant)"

      # -------------------- SSH --------------------
      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.O2SWITCH_SSH_KEY }}

      - name: Add o2switch host to known_hosts (best effort)
        run: |
          set -e
          HOST="${{ secrets.O2SWITCH_SSH_HOST }}"
          if [ -z "$HOST" ]; then
            HOST=$(echo "${{ secrets.O2SWITCH_REMOTE_RELEASE }}" | awk -F'[@/]' '{print $2}')
          fi

          mkdir -p ~/.ssh
          ssh-keyscan -H "$HOST" >> ~/.ssh/known_hosts || true

          # CI only: évite blocage si keyscan rate (host key verification)
          echo -e "Host *\n\tStrictHostKeyChecking no\n" >> ~/.ssh/config

      # ============================================================
      # 1) DEPLOY RELEASE
      # ============================================================
      - name: Generate .cpanel.yml for RELEASE
        run: |
          set -e
          cat > .cpanel.yml <<'YML'
          ---
          deployment:
            tasks:
              - export DEPLOY_FOLDER="release"
              - export DEPLOYPATH="$HOME/public_html/${DEPLOY_FOLDER}"
              - /bin/echo "Deploying to $DEPLOYPATH"
              - /bin/mkdir -p "$DEPLOYPATH"
              - /usr/bin/rsync -az --delete --exclude ".git/" --exclude ".github/" ./ "$DEPLOYPATH/"
              - /usr/bin/find "$DEPLOYPATH" -type d -exec chmod 755 {} \;
              - /usr/bin/find "$DEPLOYPATH" -type f -exec chmod 644 {} \;
              - /bin/echo "Deployed on $(/bin/date -Iseconds)" > "$DEPLOYPATH/deploy-info.txt"
          YML

      - name: Push to o2switch RELEASE repo
        run: |
          set -e
          git remote add o2switch_release "${{ secrets.O2SWITCH_REMOTE_RELEASE }}" || \
            git remote set-url o2switch_release "${{ secrets.O2SWITCH_REMOTE_RELEASE }}"

          if git rev-parse --is-shallow-repository | grep -q true; then
            git fetch --unshallow
          fi

          git push -f o2switch_release HEAD:refs/heads/main

      # ============================================================
      # 2) SMOKE TESTS RELEASE
      # ============================================================
      - name: Smoke test RELEASE
        run: |
          set -e
          URL="https://release.p-wf.fr"

          echo "Checking $URL ..."
          for i in $(seq 1 25); do
            code=$(curl -k -s -o /dev/null -w "%{http_code}" "$URL" || true)
            echo "Attempt $i => HTTP $code"
            if [ "$code" = "200" ] || [ "$code" = "301" ] || [ "$code" = "302" ]; then
              echo "Release is reachable."
              break
            fi
            sleep 8
          done

          # Check contenu HTML
          curl -k -s "$URL" | head -n 20

      # ============================================================
      # 3) PROMOTION PROD
      # ============================================================
      - name: Generate .cpanel.yml for PROD
        run: |
          set -e
          cat > .cpanel.yml <<'YML'
          ---
          deployment:
            tasks:
              - export DEPLOY_FOLDER="tp"
              - export DEPLOYPATH="$HOME/public_html/${DEPLOY_FOLDER}"
              - /bin/echo "Deploying to $DEPLOYPATH"
              - /bin/mkdir -p "$DEPLOYPATH"
              - /usr/bin/rsync -az --delete --exclude ".git/" --exclude ".github/" ./ "$DEPLOYPATH/"
              - /usr/bin/find "$DEPLOYPATH" -type d -exec chmod 755 {} \;
              - /usr/bin/find "$DEPLOYPATH" -type f -exec chmod 644 {} \;
              - /bin/echo "Deployed on $(/bin/date -Iseconds)" > "$DEPLOYPATH/deploy-info.txt"
          YML

      - name: Push to o2switch PROD repo
        run: |
          set -e
          git remote add o2switch_prod "${{ secrets.O2SWITCH_REMOTE_PROD }}" || \
            git remote set-url o2switch_prod "${{ secrets.O2SWITCH_REMOTE_PROD }}"

          git push -f o2switch_prod HEAD:refs/heads/main

      - name: Smoke test PROD
        run: |
          set -e
          URL="https://tp.p-wf.fr"

          echo "Checking $URL ..."
          for i in $(seq 1 25); do
            code=$(curl -k -s -o /dev/null -w "%{http_code}" "$URL" || true)
            echo "Attempt $i => HTTP $code"
            if [ "$code" = "200" ] || [ "$code" = "301" ] || [ "$code" = "302" ]; then
              echo "Prod is reachable."
              break
            fi
            sleep 8
          done

          curl -k -s "$URL" | head -n 20
