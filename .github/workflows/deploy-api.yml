name: CI/CD vers o2switch via API

on:
  push:
    branches: ["main"]

jobs:
  Test-and-Deploy-web-via-API:
    runs-on: ubuntu-latest

    env:
      CPANEL_SERVER: ${{ secrets.CPANEL_SERVER }}      # ex: mon_id.o2switch.net
      CPANEL_LOGIN:  ${{ secrets.CPANEL_LOGIN }}       # ex: mon_id
      CPANEL_TOKEN:  ${{ secrets.CPANEL_TOKEN }}       # token API cPanel
      O2SWITCH_REMOTE: ${{ secrets.O2SWITCH_REMOTE }}  # repertoire cloner

    steps:
      # 1) Checkout complet
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # (sécurité au cas où)
      - name: Ensure repository is not shallow
        run: |
          if git rev-parse --is-shallow-repository | grep -q true; then
            git fetch --unshallow
          fi

      # 2) Tests rapides
      - name: Basic checks
        run: |
          set -e
          test -f index.html || (echo "❌ index.html manquant" >&2; exit 1)
          if find . -type f -size +5M -not -path "./.git/*" | grep -q .; then
            echo "❌ Fichiers > 5 Mo détectés." >&2; exit 1
          fi
          echo "✅ Checks OK"

      # 3) Validation HTML (non bloquante)
      - name: HTML validation (permissive)
        continue-on-error: true
        run: |
          sudo apt-get update && sudo apt-get install -y tidy
          tidy -qe -utf8 index.html || echo "⚠️ Tidy a signalé des problèmes (non bloquant)"

      # 4) Whitelist IP du runner via l’API o2switch
      - name: Whitelist runner IP on o2switch firewall (SSH/22)
        id: fw_add
        run: |
          set -e
          sudo apt-get update && sudo apt-get install -y jq curl
          IP=$(curl -s https://api.ipify.org)
          echo "Runner IP: $IP"
          echo "ip=$IP" >> "$GITHUB_OUTPUT"
          RESP=$(curl -sm 45 -H "Authorization: cpanel ${CPANEL_LOGIN}:${CPANEL_TOKEN}" \
            "https://${CPANEL_SERVER}:2083/execute/SshWhitelist/add?address=${IP}&port=22")
          echo "$RESP" | jq .
          test "$(echo "$RESP" | jq -r '.status')" = "1"

      # 5) Agent SSH (clé privée)
      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.O2SWITCH_SSH_KEY }}

      # 6) known_hosts résilient
      - name: Add o2switch host to known_hosts (resilient)
        continue-on-error: true
        shell: bash
        run: |
          set -e
          mkdir -p ~/.ssh && chmod 700 ~/.ssh
          touch ~/.ssh/known_hosts && chmod 600 ~/.ssh/known_hosts
          HOST=$(echo "${O2SWITCH_REMOTE}" | sed -E 's#ssh://([^@]+@)?([^/:]+).*#\2#')
          echo "Detected host: $HOST"
          ssh-keyscan -T 30 -H "$HOST" >> ~/.ssh/known_hosts || true
          {
            echo "Host $HOST"
            echo "  StrictHostKeyChecking no"
            echo "  UserKnownHostsFile=/dev/null"
          } >> ~/.ssh/config
          chmod 600 ~/.ssh/config || true

      # 7) (debug facultatif)
      - name: Debug SSH & remote (non-blocking)
        continue-on-error: true
        run: |
          set -e
          echo "REMOTE=${O2SWITCH_REMOTE}"
          GIT_SSH_COMMAND="ssh -o BatchMode=yes -o StrictHostKeyChecking=yes -vvv" git ls-remote "${O2SWITCH_REMOTE}"

      # 8) Push vers le dépôt Git™ o2switch (déclenche .cpanel.yml côté serveur)
      - name: Push to o2switch repo
        run: |
          set -e
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git remote | grep -q '^o2switch$' || git remote add o2switch "${O2SWITCH_REMOTE}"
          GIT_SSH_COMMAND="ssh -o BatchMode=yes" git push -f o2switch HEAD:refs/heads/main

      # 9) Nettoyage whitelist (toujours exécuté)
      - name: Remove runner IP from whitelist
        if: always()
        run: |
          set -e
          sudo apt-get update && sudo apt-get install -y jq curl
          IP="${{ steps.fw_add.outputs.ip }}"
          echo "Removing $IP from whitelist"
          for DIR in in out; do
            RESP=$(curl -sm 45 -H "Authorization: cpanel ${CPANEL_LOGIN}:${CPANEL_TOKEN}" \
              "https://${CPANEL_SERVER}:2083/execute/SshWhitelist/remove?address=${IP}&port=22&direction=${DIR}")
            echo "$RESP" | jq .
          done
