name: Test -> Release -> Promote Prod (o2switch)

on:
  push:
    branches: ["main"]

concurrency:
  group: deploy-o2switch
  cancel-in-progress: true

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest

    env:
      CPANEL_SERVER:  ${{ secrets.CPANEL_SERVER }}
      CPANEL_LOGIN:   ${{ secrets.CPANEL_LOGIN }}
      CPANEL_TOKEN:   ${{ secrets.CPANEL_TOKEN }}
      O2SWITCH_REMOTE_RELEASE: ${{ secrets.O2SWITCH_REMOTE_RELEASE }}
      O2SWITCH_REMOTE_PROD:    ${{ secrets.O2SWITCH_REMOTE_PROD }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Show current commit & files
        run: |
          set -euo pipefail
          echo "Commit:"
          git rev-parse HEAD
          echo "Branch:"
          git branch --show-current || true
          echo "Top files:"
          ls -la

      # -------------------- TESTS --------------------
      - name: Basic project checks
        run: |
          set -euo pipefail
          test -f index.html || (echo "âŒ index.html manquant" >&2; exit 1)

          if find . -type f -size +5M -not -path "./.git/*" -not -path "./.github/*" | grep -q .; then
            echo "âŒ Fichiers > 5 Mo dÃ©tectÃ©s." >&2
            find . -type f -size +5M -not -path "./.git/*" -not -path "./.github/*"
            exit 1
          fi

      - name: HTML validation (tidy) non-bloquant
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y tidy
          tidy -errors -q index.html || echo "âš ï¸ Tidy a signalÃ© des problÃ¨mes (non bloquant)"

      # -------------------- SSH --------------------
      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.O2SWITCH_SSH_KEY }}

      - name: Debug secrets presence (no leak)
        run: |
          set -euo pipefail
          test -n "${O2SWITCH_REMOTE_RELEASE}" || (echo "âŒ O2SWITCH_REMOTE_RELEASE est vide" >&2; exit 1)
          test -n "${O2SWITCH_REMOTE_PROD}" || (echo "âŒ O2SWITCH_REMOTE_PROD est vide" >&2; exit 1)
          echo "âœ… Remotes secrets are present."

      - name: Add o2switch host to known_hosts (best effort)
        run: |
          set -euo pipefail
          HOST=$(echo "${O2SWITCH_REMOTE_RELEASE}" | awk -F'[@/]' '{print $2}')
          echo "Detected host: $HOST"
          mkdir -p ~/.ssh
          ssh-keyscan -H "$HOST" >> ~/.ssh/known_hosts || true
          echo -e "Host *\n\tStrictHostKeyChecking no\n" >> ~/.ssh/config

      - name: SSH connectivity test (release host)
        run: |
          set -euo pipefail
          HOST=$(echo "${O2SWITCH_REMOTE_RELEASE}" | awk -F'[@/]' '{print $2}')
          echo "Testing ssh to $HOST ..."
          # On teste juste la connexion, sans commande serveur
          ssh -o BatchMode=yes -o ConnectTimeout=15 "${HOST}" true || true
          echo "âœ… SSH test step executed (even if host blocks command)."

      # ============================================================
      # 1) DEPLOY RELEASE
      # ============================================================
      - name: Generate .cpanel.yml for RELEASE
        run: |
          set -euo pipefail
          cat > .cpanel.yml <<'YML'
          ---
          deployment:
            tasks:
              - export DEPLOY_FOLDER="release"
              - export DEPLOYPATH="$HOME/public_html/${DEPLOY_FOLDER}"
              - /bin/echo "Deploying to $DEPLOYPATH"
              - /bin/mkdir -p "$DEPLOYPATH"
              - /usr/bin/rsync -az --delete --exclude ".git/" --exclude ".github/" ./ "$DEPLOYPATH/"
              - /usr/bin/find "$DEPLOYPATH" -type d -exec chmod 755 {} \;
              - /usr/bin/find "$DEPLOYPATH" -type f -exec chmod 644 {} \;
              - /bin/echo "Deployed on $(/bin/date -Iseconds)" > "$DEPLOYPATH/deploy-info.txt"
          YML

      - name: Push to o2switch RELEASE repo (with full debug)
        run: |
          set -euo pipefail
          echo "Remote release is: (masked by GH if needed)"
          echo "${O2SWITCH_REMOTE_RELEASE}"

          echo "ðŸ”Ž Git remotes before:"
          git remote -v || true

          if git remote get-url o2switch_release >/dev/null 2>&1; then
            git remote set-url o2switch_release "${O2SWITCH_REMOTE_RELEASE}"
          else
            git remote add o2switch_release "${O2SWITCH_REMOTE_RELEASE}"
          fi

          echo "ðŸ”Ž Git remotes after:"
          git remote -v

          echo "ðŸ”Ž Is shallow?"
          git rev-parse --is-shallow-repository || true
          if git rev-parse --is-shallow-repository | grep -q true; then
            git fetch --unshallow
          fi

          echo "ðŸ”Ž Pushing HEAD to release/main..."
          git push -f o2switch_release HEAD:refs/heads/main

      # ============================================================
      # 2) SMOKE TEST RELEASE
      # ============================================================
      - name: Smoke test RELEASE
        run: |
          set -euo pipefail
          URL="https://release.p-wf.fr"
          echo "Checking $URL ..."
          for i in $(seq 1 25); do
            code=$(curl -k -s -o /dev/null -w "%{http_code}" "$URL" || true)
            echo "Attempt $i => HTTP $code"
            if [ "$code" = "200" ] || [ "$code" = "301" ] || [ "$code" = "302" ]; then
              echo "âœ… Release reachable"
              break
            fi
            sleep 8
          done
          curl -k -s "$URL" | head -n 20

      # ============================================================
      # 3) PROMOTION PROD
      # ============================================================
      - name: Generate .cpanel.yml for PROD
        run: |
          set -euo pipefail
          cat > .cpanel.yml <<'YML'
          ---
          deployment:
            tasks:
              - export DEPLOY_FOLDER="tp"
              - export DEPLOYPATH="$HOME/public_html/${DEPLOY_FOLDER}"
              - /bin/echo "Deploying to $DEPLOYPATH"
              - /bin/mkdir -p "$DEPLOYPATH"
              - /usr/bin/rsync -az --delete --exclude ".git/" --exclude ".github/" ./ "$DEPLOYPATH/"
              - /usr/bin/find "$DEPLOYPATH" -type d -exec chmod 755 {} \;
              - /usr/bin/find "$DEPLOYPATH" -type f -exec chmod 644 {} \;
              - /bin/echo "Deployed on $(/bin/date -Iseconds)" > "$DEPLOYPATH/deploy-info.txt"
          YML

      - name: Push to o2switch PROD repo
        run: |
          set -euo pipefail
          if git remote get-url o2switch_prod >/dev/null 2>&1; then
            git remote set-url o2switch_prod "${O2SWITCH_REMOTE_PROD}"
          else
            git remote add o2switch_prod "${O2SWITCH_REMOTE_PROD}"
          fi
          git push -f o2switch_prod HEAD:refs/heads/main

      - name: Smoke test PROD
        run: |
          set -euo pipefail
          URL="https://tp.p-wf.fr"
          echo "Checking $URL ..."
          for i in $(seq 1 25); do
            code=$(curl -k -s -o /dev/null -w "%{http_code}" "$URL" || true)
            echo "Attempt $i => HTTP $code"
            if [ "$code" = "200" ] || [ "$code" = "301" ] || [ "$code" = "302" ]; then
              echo "âœ… Prod reachable"
              break
            fi
            sleep 8
          done
          curl -k -s "$URL" | head -n 20
