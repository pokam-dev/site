name: Test -> Release -> Promote Prod (o2switch + Firewall API)

on:
  push:
    branches: ["main"]

concurrency:
  group: deploy-o2switch
  cancel-in-progress: true

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest

    env:
      CPANEL_SERVER:  ${{ secrets.CPANEL_SERVER }}   # ex: truie.o2switch.net
      CPANEL_LOGIN:   ${{ secrets.CPANEL_LOGIN }}    # ex: keze7545
      CPANEL_TOKEN:   ${{ secrets.CPANEL_TOKEN }}    # token API cPanel
      O2SWITCH_REMOTE_RELEASE: ${{ secrets.O2SWITCH_REMOTE_RELEASE }}
      O2SWITCH_REMOTE_PROD:    ${{ secrets.O2SWITCH_REMOTE_PROD }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -------------------- TESTS --------------------
      - name: Basic project checks
        run: |
          set -euo pipefail
          test -f index.html || (echo "❌ index.html manquant" >&2; exit 1)

          if find . -type f -size +5M -not -path "./.git/*" -not -path "./.github/*" | grep -q .; then
            echo "❌ Fichiers > 5 Mo détectés." >&2
            find . -type f -size +5M -not -path "./.git/*" -not -path "./.github/*"
            exit 1
          fi

      - name: HTML validation (tidy) non-bloquant
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y tidy
          tidy -errors -q index.html || echo "⚠️ Tidy a signalé des problèmes (non bloquant)"

      # -------------------- RUNNER IP --------------------
      - name: Get runner public IP
        id: ip
        run: |
          set -euo pipefail
          IP="$(curl -s https://api.ipify.org)"
          echo "ip=$IP" >> "$GITHUB_OUTPUT"
          echo "Runner IP: $IP"

      # -------------------- FIREWALL EXCEPTION (API) --------------------
      - name: Allow runner IP in o2switch firewall (API) - attempt #1
        run: |
          set -euo pipefail
          IP="${{ steps.ip.outputs.ip }}"
          echo "Allowing IP via API (attempt #1): $IP"

          # Endpoint possible 1
          curl -sS -k \
            -H "Authorization: cpanel ${CPANEL_LOGIN}:${CPANEL_TOKEN}" \
            "https://${CPANEL_SERVER}:2083/execute/O2switch_firewall/add?ip=${IP}&comment=github-actions" \
            | head -c 800 || true

      - name: Allow runner IP in o2switch firewall (API) - attempt #2
        run: |
          set -euo pipefail
          IP="${{ steps.ip.outputs.ip }}"
          echo "Allowing IP via API (attempt #2): $IP"

          # Endpoint possible 2 (selon implémentation)
          curl -sS -k \
            -H "Authorization: cpanel ${CPANEL_LOGIN}:${CPANEL_TOKEN}" \
            "https://${CPANEL_SERVER}:2083/execute/O2switchFirewall/add?ip=${IP}&comment=github-actions" \
            | head -c 800 || true

      # -------------------- SSH --------------------
      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.O2SWITCH_SSH_KEY }}

      - name: Add o2switch host to known_hosts (best effort)
        run: |
          set -euo pipefail
          HOST=$(echo "${O2SWITCH_REMOTE_RELEASE}" | awk -F'[@/]' '{print $2}')
          echo "Detected host: $HOST"
          mkdir -p ~/.ssh
          ssh-keyscan -H "$HOST" >> ~/.ssh/known_hosts || true
          echo -e "Host *\n\tStrictHostKeyChecking no\n" >> ~/.ssh/config

      # ============================================================
      # 1) DEPLOY RELEASE
      # ============================================================
      - name: Generate .cpanel.yml for RELEASE
        run: |
          set -euo pipefail
          cat > .cpanel.yml <<'YML'
          ---
          deployment:
            tasks:
              - export DEPLOY_FOLDER="release"
              - export DEPLOYPATH="$HOME/public_html/${DEPLOY_FOLDER}"
              - /bin/echo "Deploying to $DEPLOYPATH"
              - /bin/mkdir -p "$DEPLOYPATH"
              - /usr/bin/rsync -az --delete --exclude ".git/" --exclude ".github/" ./ "$DEPLOYPATH/"
              - /usr/bin/find "$DEPLOYPATH" -type d -exec chmod 755 {} \;
              - /usr/bin/find "$DEPLOYPATH" -type f -exec chmod 644 {} \;
              - /bin/echo "Deployed on $(/bin/date -Iseconds)" > "$DEPLOYPATH/deploy-info.txt"
          YML

      - name: Push to o2switch RELEASE repo
        run: |
          set -euo pipefail
          test -n "${O2SWITCH_REMOTE_RELEASE}" || (echo "❌ O2SWITCH_REMOTE_RELEASE vide" >&2; exit 1)

          if git remote get-url o2switch_release >/dev/null 2>&1; then
            git remote set-url o2switch_release "${O2SWITCH_REMOTE_RELEASE}"
          else
            git remote add o2switch_release "${O2SWITCH_REMOTE_RELEASE}"
          fi

          # Evite "shallow update not allowed"
          if git rev-parse --is-shallow-repository | grep -q true; then
            git fetch --unshallow
          fi

          git push -f o2switch_release HEAD:refs/heads/main

      - name: Smoke test RELEASE
        run: |
          set -euo pipefail
          URL="https://release.p-wf.fr"
          echo "Checking $URL ..."
          for i in $(seq 1 25); do
            code=$(curl -k -s -o /dev/null -w "%{http_code}" "$URL" || true)
            echo "Attempt $i => HTTP $code"
            if [ "$code" = "200" ] || [ "$code" = "301" ] || [ "$code" = "302" ]; then
              echo "✅ Release reachable"
              break
            fi
            sleep 8
          done
          curl -k -s "$URL" | head -n 30

      # ============================================================
      # 2) PROMOTE PROD
      # ============================================================
      - name: Generate .cpanel.yml for PROD
        run: |
          set -euo pipefail
          cat > .cpanel.yml <<'YML'
          ---
          deployment:
            tasks:
              - export DEPLOY_FOLDER="tp"
              - export DEPLOYPATH="$HOME/public_html/${DEPLOY_FOLDER}"
              - /bin/echo "Deploying to $DEPLOYPATH"
              - /bin/mkdir -p "$DEPLOYPATH"
              - /usr/bin/rsync -az --delete --exclude ".git/" --exclude ".github/" ./ "$DEPLOYPATH/"
              - /usr/bin/find "$DEPLOYPATH" -type d -exec chmod 755 {} \;
              - /usr/bin/find "$DEPLOYPATH" -type f -exec chmod 644 {} \;
              - /bin/echo "Deployed on $(/bin/date -Iseconds)" > "$DEPLOYPATH/deploy-info.txt"
          YML

      - name: Push to o2switch PROD repo
        run: |
          set -euo pipefail
          test -n "${O2SWITCH_REMOTE_PROD}" || (echo "❌ O2SWITCH_REMOTE_PROD vide" >&2; exit 1)

          if git remote get-url o2switch_prod >/dev/null 2>&1; then
            git remote set-url o2switch_prod "${O2SWITCH_REMOTE_PROD}"
          else
            git remote add o2switch_prod "${O2SWITCH_REMOTE_PROD}"
          fi

          git push -f o2switch_prod HEAD:refs/heads/main

      - name: Smoke test PROD
        run: |
          set -euo pipefail
          URL="https://tp.p-wf.fr"
          echo "Checking $URL ..."
          for i in $(seq 1 25); do
            code=$(curl -k -s -o /dev/null -w "%{http_code}" "$URL" || true)
            echo "Attempt $i => HTTP $code"
            if [ "$code" = "200" ] || [ "$code" = "301" ] || [ "$code" = "302" ]; then
              echo "✅ Prod reachable"
              break
            fi
            sleep 8
          done
          curl -k -s "$URL" | head -n 30

      # -------------------- (OPTIONNEL) RETRAIT IP --------------------
      - name: Remove runner IP from firewall (best effort)
        if: always()
        run: |
          set -euo pipefail
          IP="${{ steps.ip.outputs.ip }}"
          echo "Removing IP (best effort): $IP"

          # Endpoint possible 1
          curl -sS -k \
            -H "Authorization: cpanel ${CPANEL_LOGIN}:${CPANEL_TOKEN}" \
            "https://${CPANEL_SERVER}:2083/execute/O2switch_firewall/remove?ip=${IP}" \
            | head -c 800 || true

          # Endpoint possible 2
          curl -sS -k \
            -H "Authorization: cpanel ${CPANEL_LOGIN}:${CPANEL_TOKEN}" \
            "https://${CPANEL_SERVER}:2083/execute/O2switchFirewall/remove?ip=${IP}" \
            | head -c 800 || true
