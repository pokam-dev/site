name: CI/CD o2switch (Release -> Prod) via API Token

on:
  push:
    branches: ["main"]
  workflow_dispatch:

concurrency:
  group: deploy-o2switch-${{ github.ref }}
  cancel-in-progress: true

jobs:
  release-then-prod:
    runs-on: ubuntu-latest

    env:
      CPANEL_SERVER: ${{ secrets.CPANEL_SERVER }}          # ex: truie.o2switch.net
      CPANEL_LOGIN:  ${{ secrets.CPANEL_LOGIN }}           # ex: keze7545
      CPANEL_TOKEN:  ${{ secrets.CPANEL_TOKEN }}           # token API cPanel

      O2SWITCH_REMOTE_RELEASE: ${{ secrets.O2SWITCH_REMOTE_RELEASE }}  # ssh://.../repositories/release
      O2SWITCH_REMOTE_PROD:    ${{ secrets.O2SWITCH_REMOTE_PROD }}     # ssh://.../repositories/tp-site

      # Chemins ABSOLUS des repos côté serveur (pour l'API deploy)
      CPANEL_REPO_PATH_RELEASE: /home/keze7545/repositories/release
      CPANEL_REPO_PATH_PROD:    /home/keze7545/repositories/tp-site

    steps:
      # 1) Checkout complet
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # (sécurité au cas où)
      - name: Ensure repository is not shallow
        run: |
          if git rev-parse --is-shallow-repository | grep -q true; then
            git fetch --unshallow
          fi

      # 2) Tests rapides
      - name: Basic checks
        run: |
          set -euo pipefail
          test -f index.html || (echo "❌ index.html manquant" >&2; exit 1)

          if find . -type f -size +5M -not -path "./.git/*" | grep -q .; then
            echo "❌ Fichiers > 5 Mo détectés." >&2
            find . -type f -size +5M -not -path "./.git/*" -print >&2
            exit 1
          fi
          echo "✅ Checks OK"

      # 3) Validation HTML (non bloquante)
      - name: HTML validation (permissive)
        continue-on-error: true
        run: |
          sudo apt-get update
          sudo apt-get install -y tidy
          tidy -qe -utf8 index.html || echo "⚠️ Tidy a signalé des problèmes (non bloquant)"

      # 4) Whitelist IP du runner via API o2switch (SSH/22)
      - name: Whitelist runner IP on o2switch firewall (SSH/22)
        id: fw_add
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y jq curl

          IP=$(curl -s https://api.ipify.org)
          echo "Runner IP: $IP"
          echo "ip=$IP" >> "$GITHUB_OUTPUT"

          RESP=$(curl -sm 45 -H "Authorization: cpanel ${CPANEL_LOGIN}:${CPANEL_TOKEN}" \
            "https://${CPANEL_SERVER}:2083/execute/SshWhitelist/add?address=${IP}&port=22")
          echo "$RESP" | jq .
          test "$(echo "$RESP" | jq -r '.status')" = "1"

      # 5) Agent SSH (clé privée)
      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.O2SWITCH_SSH_KEY }}

      # 6) known_hosts (safe)
      - name: Add o2switch hosts to known_hosts
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh && chmod 700 ~/.ssh
          touch ~/.ssh/known_hosts && chmod 600 ~/.ssh/known_hosts

          REL_HOST=$(echo "${O2SWITCH_REMOTE_RELEASE}" | sed -E 's#ssh://([^@]+@)?([^/:]+).*#\2#')
          PROD_HOST=$(echo "${O2SWITCH_REMOTE_PROD}"    | sed -E 's#ssh://([^@]+@)?([^/:]+).*#\2#')

          echo "Release host: $REL_HOST"
          echo "Prod host:    $PROD_HOST"

          ssh-keyscan -T 30 -H "$REL_HOST"  >> ~/.ssh/known_hosts || true
          ssh-keyscan -T 30 -H "$PROD_HOST" >> ~/.ssh/known_hosts || true

          cat >> ~/.ssh/config <<EOF
          Host $REL_HOST
            StrictHostKeyChecking accept-new
            UserKnownHostsFile ~/.ssh/known_hosts
          Host $PROD_HOST
            StrictHostKeyChecking accept-new
            UserKnownHostsFile ~/.ssh/known_hosts
          EOF
          chmod 600 ~/.ssh/config

      # =========================
      # RELEASE: Push + Deploy
      # =========================
      - name: Push to o2switch RELEASE repo
        run: |
          set -euo pipefail
          git remote remove o2switch_release 2>/dev/null || true
          git remote add o2switch_release "${O2SWITCH_REMOTE_RELEASE}"
          GIT_SSH_COMMAND="ssh -o BatchMode=yes" git push -f o2switch_release HEAD:refs/heads/main

      - name: Trigger cPanel Deploy for RELEASE (API)
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y jq curl

          # cPanel API: VersionControl/deploy
          URL="https://${CPANEL_SERVER}:2083/execute/VersionControl/deploy"
          REPO_ENC=$(python3 -c 'import urllib.parse,os; print(urllib.parse.quote(os.environ["CPANEL_REPO_PATH_RELEASE"]))')

          RESP=$(curl -sS -m 60 \
            -H "Authorization: cpanel ${CPANEL_LOGIN}:${CPANEL_TOKEN}" \
            "${URL}?repository_root=${REPO_ENC}")

          echo "$RESP" | jq .
          test "$(echo "$RESP" | jq -r '.status')" = "1"

      - name: Smoke test RELEASE
        run: |
          set -euo pipefail
          URL="https://release.p-wf.fr"
          echo "Checking $URL ..."
          for i in $(seq 1 25); do
            code=$(curl -k -s -o /dev/null -w "%{http_code}" "$URL" || true)
            echo "Attempt $i => HTTP $code"
            if [ "$code" = "200" ] || [ "$code" = "301" ] || [ "$code" = "302" ]; then
              echo "✅ Release reachable"
              break
            fi
            sleep 8
          done
          curl -k -s "$URL" | head -n 20

      # =========================
      # PROD: Push + Deploy
      # =========================
      - name: Push to o2switch PROD repo
        run: |
          set -euo pipefail
          git remote remove o2switch_prod 2>/dev/null || true
          git remote add o2switch_prod "${O2SWITCH_REMOTE_PROD}"
          GIT_SSH_COMMAND="ssh -o BatchMode=yes" git push -f o2switch_prod HEAD:refs/heads/main

      - name: Trigger cPanel Deploy for PROD (API)
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y jq curl

          URL="https://${CPANEL_SERVER}:2083/execute/VersionControl/deploy"
          REPO_ENC=$(python3 -c 'import urllib.parse,os; print(urllib.parse.quote(os.environ["CPANEL_REPO_PATH_PROD"]))')

          RESP=$(curl -sS -m 60 \
            -H "Authorization: cpanel ${CPANEL_LOGIN}:${CPANEL_TOKEN}" \
            "${URL}?repository_root=${REPO_ENC}")

          echo "$RESP" | jq .
          test "$(echo "$RESP" | jq -r '.status')" = "1"

      - name: Smoke test PROD
        run: |
          set -euo pipefail
          URL="https://tp.p-wf.fr"
          echo "Checking $URL ..."
          for i in $(seq 1 25); do
            code=$(curl -k -s -o /dev/null -w "%{http_code}" "$URL" || true)
            echo "Attempt $i => HTTP $code"
            if [ "$code" = "200" ] || [ "$code" = "301" ] || [ "$code" = "302" ]; then
              echo "✅ Prod reachable"
              break
            fi
            sleep 8
          done
          curl -k -s "$URL" | head -n 20

      # 9) Nettoyage whitelist (toujours exécuté)
      - name: Remove runner IP from whitelist
        if: always()
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y jq curl

          IP="${{ steps.fw_add.outputs.ip }}"
          echo "Removing $IP from whitelist"
          for DIR in in out; do
            RESP=$(curl -sm 45 -H "Authorization: cpanel ${CPANEL_LOGIN}:${CPANEL_TOKEN}" \
              "https://${CPANEL_SERVER}:2083/execute/SshWhitelist/remove?address=${IP}&port=22&direction=${DIR}")
            echo "$RESP" | jq .
          done
