name: CI & Deploy to o2switch

on:
  push:
    branches: ["main"]

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1) Récupérer le code
      - name: Checkout
        uses: actions/checkout@v4

      # 2) Vérifications de base (fichiers requis, taille max)
      - name: Vérifications de base
        run: |
          set -e
          test -f index.html || (echo "❌ index.html manquant à la racine" >&2; exit 1)
          # Pas de fichiers > 5 Mo (bonne pratique pour un site vitrine)
          if find . -type f -size +5M -not -path "./.git/*" | grep -q .; then
            echo "❌ Des fichiers dépassent 5 Mo, optimise-les avant déploiement." >&2
            exit 1
          fi
          echo "✅ Vérifs de base OK"

      # 3) Validation HTML (non bloquante pour ne pas stopper le déploiement)
      - name: Validation HTML (permissive)
        continue-on-error: true
        run: |
          sudo apt-get update
          sudo apt-get install -y tidy
          # -q silencieux, -e erreurs seulement, -utf8 encodage
          tidy -qe -utf8 index.html || echo "⚠️ Tidy a signalé des problèmes (non bloquant)"

      # 4) Préparer l'agent SSH avec la clé privée stockée en secret
      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.O2SWITCH_SSH_KEY }}

           # 5) Ajouter l'hôte o2switch dans known_hosts (robuste, avec fallback)
      - name: Add o2switch host to known_hosts (robust)
        shell: bash
        run: |
          set -e
          HOST=$(echo "${{ secrets.O2SWITCH_REMOTE }}" | sed -E 's#ssh://([^@]+@)?([^/:]+).*#\2#')
          echo "Detected host: $HOST"

          # Essai 1 : host tel quel (odns.fr)
          ssh-keyscan -T 20 -H "$HOST" >> ~/.ssh/known_hosts || true

          # Essai 2 : variante domaine (o2switch.net) au cas où
          ALT_HOST="${HOST/.odns.fr/.o2switch.net}"
          if [ "$ALT_HOST" != "$HOST" ]; then
            ssh-keyscan -T 20 -H "$ALT_HOST" >> ~/.ssh/known_hosts || true
          fi

          # Si toujours vide, fallback: désactiver la vérif stricte pour ce host
          if ! grep -q "$HOST" ~/.ssh/known_hosts && ! grep -q "$ALT_HOST" ~/.ssh/known_hosts; then
            echo "ssh-keyscan failed, falling back to relaxed host checking for CI only."
            {
              echo "Host $HOST"
              echo "  StrictHostKeyChecking no"
              echo "  UserKnownHostsFile=/dev/null"
              [ "$ALT_HOST" != "$HOST" ] && echo -e "Host $ALT_HOST\n  StrictHostKeyChecking no\n  UserKnownHostsFile=/dev/null"
            } >> ~/.ssh/config
          fi


      # 6) (Optionnel) Diagnostic de connectivité Git/SSH sans échouer le job
      - name: Debug SSH & remote (non-bloquant)
        continue-on-error: true
        run: |
          set -e
          echo "REMOTE=${{ secrets.O2SWITCH_REMOTE }}"
          GIT_SSH_COMMAND="ssh -o BatchMode=yes -o StrictHostKeyChecking=yes -vvv" git ls-remote "${{ secrets.O2SWITCH_REMOTE }}"

      # 7) Push du code vers le dépôt Git™ d’o2switch
      - name: Push to o2switch repo
        run: |
          set -e
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          # Ajoute le remote 'o2switch' si absent
          if ! git remote | grep -q '^o2switch$'; then
            git remote add o2switch "${{ secrets.O2SWITCH_REMOTE }}"
          fi
          # Force la branche distante 'main' (dépôt o2switch vide au départ)
          git push -f o2switch HEAD:refs/heads/main
